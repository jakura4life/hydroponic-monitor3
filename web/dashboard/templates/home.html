{% extends "base.html" %}
{% block title %}Home - Hydroponic Dashboard{% endblock %}

{% block extra_css %}
<!-- Tailwind + optional custom CSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-6" x-data="{ alertMessage: '', showAlert: false }">

    <h1 class="text-3xl font-bold mb-6">Hydroponic Dashboard</h1>

    <!-- Alerts -->
    <div 
        x-show="showAlert"
        x-text="alertMessage"
        class="p-4 mb-4 rounded text-white bg-red-500"
        style="display:none;"
    ></div>

    <!-- Current Sensor Readings -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="p-4 bg-white rounded shadow">
            <h2 class="font-semibold">pH</h2>
            <p class="text-xl" id="ph">--</p>
        </div>
        <div class="p-4 bg-white rounded shadow">
            <h2 class="font-semibold">TDS (ppm)</h2>
            <p class="text-xl" id="tds">--</p>
        </div>
        <div class="p-4 bg-white rounded shadow">
            <h2 class="font-semibold">Air Temp (°C)</h2>
            <p class="text-xl" id="temp">--</p>
        </div>
        <div class="p-4 bg-white rounded shadow">
            <h2 class="font-semibold">Humidity (%)</h2>
            <p class="text-xl" id="humidity">--</p>
        </div>
    </div>

    <!-- Last update -->
    <p class="mb-6">Last updated: <span id="updated">--</span></p>

    <!-- Hourly Chart -->
    <canvas id="hourlyChart" class="bg-white rounded shadow p-4"></canvas>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let hourlyChart;

    async function fetchCurrentData() {
        try {
            const response = await fetch("{% url 'current_api' %}");
            const data = await response.json();

            document.getElementById("ph").textContent = data.ph;
            document.getElementById("tds").textContent = data.tds;
            document.getElementById("temp").textContent = data.airTemp;
            document.getElementById("humidity").textContent = data.humidity;
            document.getElementById("updated").textContent = new Date().toLocaleTimeString();

            // Alert logic
            const alertEl = document.querySelector('[x-data]').__x.$data;
            if (data.ph > 7) {
                alertEl.alertMessage = "⚠ pH high — adjust nutrient solution";
                alertEl.showAlert = true;
            } else if (data.ph < 5.5) {
                alertEl.alertMessage = "⚠ pH low — adjust nutrient solution";
                alertEl.showAlert = true;
            } else {
                alertEl.showAlert = false;
            }

        } catch (err) {
            console.error("Fetch error:", err);
        }
    }

    async function fetchHourlyData() {
        try {
            const response = await fetch("{% url 'hourly_api' %}");
            const hourlyData = await response.json();

            const labels = hourlyData.map(h => new Date(h.hour).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const phValues = hourlyData.map(h => h.avg_ph);
            const tdsValues = hourlyData.map(h => h.avg_tds);
            const tempValues = hourlyData.map(h => h.avg_temp);
            const humidityValues = hourlyData.map(h => h.avg_humidity);

            if (!hourlyChart) {
                hourlyChart = new Chart(document.getElementById("hourlyChart"), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {label: 'pH', data: phValues, borderColor: 'blue', fill: false},
                            {label: 'TDS', data: tdsValues, borderColor: 'green', fill: false},
                            {label: 'Temp', data: tempValues, borderColor: 'orange', fill: false},
                            {label: 'Humidity', data: humidityValues, borderColor: 'purple', fill: false},
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: false } }
                    }
                });
            } else {
                hourlyChart.data.labels = labels;
                hourlyChart.data.datasets[0].data = phValues;
                hourlyChart.data.datasets[1].data = tdsValues;
                hourlyChart.data.datasets[2].data = tempValues;
                hourlyChart.data.datasets[3].data = humidityValues;
                hourlyChart.update();
            }

        } catch (err) {
            console.error("Hourly fetch error:", err);
        }
    }

    // Initial load
    fetchCurrentData();
    fetchHourlyData();

    // Refresh every 60 seconds
    setInterval(fetchCurrentData, 60000);
    setInterval(fetchHourlyData, 360000);
</script>
{% endblock %}